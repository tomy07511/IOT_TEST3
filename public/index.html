<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Sensores</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+4XkGkY6o5w5y/9v0u9a3p3r1sZ6m1j2kRk6b0vbg="
    crossorigin=""
  />

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #0b1d2a;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    header {
      text-align: center;
      padding: 12px;
      background: #07121a;
      border-bottom: 2px solid #00e5ff33;
    }
    header h1 {
      margin: 0;
      color: #00e5ff;
      font-size: 20px;
    }
    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      gap: 15px;
      padding: 15px;
    }
    .chart-card {
      background: #102a3c;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 0 8px #00ffff33;
      height: 320px;
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
    }
    /* Tabla y controles */
    .controls {
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      color: #fff;
    }
    th, td {
      border-bottom: 1px solid #00bcd4;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #0097a7;
    }
    tr:hover {
      background-color: #004d40;
    }
    #pagination {
      text-align: center;
      margin-top: 10px;
    }
    #pagination button {
      margin: 3px;
      background: #00bcd4;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    #pagination button:disabled {
      background: #006064;
      cursor: default;
    }
    select {
      margin: 10px;
      padding: 5px;
      border-radius: 5px;
    }
    /* Mapa */
    #map-wrapper {
      padding: 15px;
    }
    #map {
      height: 420px;
      border-radius: 10px;
      border: 2px solid #00e5ff22;
      box-shadow: 0 0 12px #00e5ff22;
    }

    footer {
      text-align: center;
      padding: 10px;
      color: #00e5ff77;
      font-size: 13px;
      margin-top: 18px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Panel de Sensores</h1>
    <div style="color:#9feaf2; font-size:13px; margin-top:6px;">Monitoreo en tiempo real â€” MQTT â†’ Node â†’ Mongo â†’ Socket.IO</div>
  </header>

  <!-- GrÃ¡ficas -->
  <div class="charts">
    <div class="chart-card"><canvas id="humedad"></canvas></div>
    <div class="chart-card"><canvas id="temperatura"></canvas></div>
    <div class="chart-card"><canvas id="conductividad"></canvas></div>
    <div class="chart-card"><canvas id="pH"></canvas></div>
    <div class="chart-card"><canvas id="nitrogeno"></canvas></div>
    <div class="chart-card"><canvas id="fosforo"></canvas></div>
    <div class="chart-card"><canvas id="potasio"></canvas></div>
    <div class="chart-card"><canvas id="bateria"></canvas></div>
    <!-- NUEVA grÃ¡fica para corriente -->
    <div class="chart-card"><canvas id="corriente"></canvas></div>
  </div>

  <!-- Controls y tabla -->
  <div class="controls">
    <h3 style="margin:0 0 8px 0; color:#00e5ff;">Registros</h3>
    <select id="tablaSelect">
      <option value="temperatura">Temperatura</option>
      <option value="humedad">Humedad</option>
      <option value="conductividad">Conductividad</option>
      <option value="pH">pH</option>
      <option value="nitrogeno">NitrÃ³geno</option>
      <option value="fosforo">FÃ³sforo</option>
      <option value="potasio">Potasio</option>
      <option value="bateria">BaterÃ­a</option>
      <option value="corriente">Corriente</option>
    </select>

    <table id="dataTable">
      <thead>
        <tr><th>Fecha</th><th>Valor</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="recordInfo" style="margin-top:10px; color:#9feaf2;"></div>
    <div id="pagination"></div>
  </div>

  <!-- Mapa GPS -->
  <div id="map-wrapper">
    <h3 style="margin-left:15px; color:#00e5ff;">UbicaciÃ³n del mÃ³dulo (GPS)</h3>
    <div id="map"></div>
  </div>

  <footer>
    Desarrollado por Dan âš¡ â€” Muestra GPS y Corriente aÃ±adidos
  </footer>

  <!-- Leaflet JS (OpenStreetMap) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Tu script principal (mantÃ©n tu script.js tal como estÃ¡) -->
  <script src="script.js"></script>

  <!-- Script pequeÃ±o para inicializar y actualizar el mapa (usa socket independiente) -->
  <script>
    (function(){
      // ConexiÃ³n propia para el mapa (no interfiere con script.js)
      const socketMap = io.connect(window.location.origin, { transports: ["websocket", "polling"] });

      // Inicializar mapa
      const map = L.map('map').setView([0,0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      let marker = null;
      let polyline = L.polyline([], { color: 'cyan' }).addTo(map); // opcional: trazo de ruta

      function updateMarker(lat, lng) {
        if (!lat || !lng) return;
        const latN = parseFloat(lat);
        const lngN = parseFloat(lng);
        if (isNaN(latN) || isNaN(lngN)) return;

        if (!marker) {
          marker = L.marker([latN, lngN]).addTo(map);
        } else {
          marker.setLatLng([latN, lngN]);
        }
        polyline.addLatLng([latN, lngN]); // aÃ±ade punto al trazo
        map.setView([latN, lngN], 15);
      }

      socketMap.on('connect', () => console.log('ðŸ”Œ Map Socket conectado'));
      socketMap.on('disconnect', () => console.log('ðŸ”Œ Map Socket desconectado'));

      // escucha nuevoDato y actualiza mapa si vienen lat/long
      socketMap.on('nuevoDato', (data) => {
        try {
          // acepta varias claves posibles: latitud/longitud o lat/lon
          const lat = data.latitud ?? data.lat ?? data.latitude ?? data.latitude_deg;
          const lon = data.longitud ?? data.lon ?? data.lng ?? data.longitude;
          if (lat !== undefined && lon !== undefined) {
            updateMarker(lat, lon);
          } else if (data.lat && data.lng) {
            updateMarker(data.lat, data.lng);
          }
        } catch (e) {
          console.error('Error actualizando mapa:', e);
        }
      });

      // Si quieres, tambiÃ©n tomar histÃ³rico cuando te conectas (por si tienes lat/lon en histÃ³rico)
      socketMap.on('historico', (arr) => {
        if (!Array.isArray(arr)) return;
        // recorrer de mÃ¡s antiguo a mÃ¡s reciente para construir la ruta
        const ordered = arr.slice().reverse();
        ordered.forEach(item => {
          const lat = item.latitud ?? item.lat ?? item.latitude;
          const lon = item.longitud ?? item.lon ?? item.longitude;
          if (lat !== undefined && lon !== undefined) {
            polyline.addLatLng([parseFloat(lat), parseFloat(lon)]);
          }
        });
        // centrar si hay puntos
        const latlngs = polyline.getLatLngs();
        if (latlngs.length) {
          map.fitBounds(polyline.getBounds(), { maxZoom: 16 });
        }
      });
    })();
  </script>
</body>
</html>
