<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Sensores LoRa</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #0d1b2a;
      color: #e0f7fa;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #00ffff;
    }
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    .chart-container {
      background: #1b263b;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 255, 255, 0.3);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #1b263b;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 15px;
      color: #00ffff;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #00ffff;
      text-align: center;
    }
    th {
      background: #0a9396;
      color: #e0f7fa;
    }
    .pagination button {
      margin: 2px;
      padding: 5px 10px;
      background: #0a9396;
      border: none;
      border-radius: 5px;
      color: #e0f7fa;
      cursor: pointer;
    }
    .pagination button:disabled {
      background: #1b263b;
      cursor: default;
    }
    select {
      margin-bottom: 10px;
      padding: 5px 10px;
      background: #0a9396;
      color: #e0f7fa;
      border: none;
      border-radius: 5px;
    }
    .record-info {
      text-align: center;
      margin-top: 8px;
      color: #00ffff;
    }
  </style>
</head>
<body>
  <h1>Panel de Monitoreo LoRa</h1>

  <!-- GRAFICAS -->
  <div class="chart-grid">
    <div class="chart-container"><canvas id="humedad"></canvas></div>
    <div class="chart-container"><canvas id="temperatura"></canvas></div>
    <div class="chart-container"><canvas id="conductividad"></canvas></div>
    <div class="chart-container"><canvas id="pH"></canvas></div>
    <div class="chart-container"><canvas id="nitrogeno"></canvas></div>
    <div class="chart-container"><canvas id="fosforo"></canvas></div>
    <div class="chart-container"><canvas id="potasio"></canvas></div>
    <div class="chart-container"><canvas id="bateria"></canvas></div>
  </div>

  <!-- TABLA -->
  <h2>Registros</h2>
  <select id="tablaSelect">
    <option value="humedad">Humedad</option>
    <option value="temperatura">Temperatura</option>
    <option value="conductividad">Conductividad</option>
    <option value="pH">pH</option>
    <option value="nitrogeno">NitrÃ³geno</option>
    <option value="fosforo">FÃ³sforo</option>
    <option value="potasio">Potasio</option>
    <option value="bateria">BaterÃ­a</option>
  </select>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Valor</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination" id="pagination"></div>
  <div class="record-info" id="recordInfo"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const SERVER_URL = "";
    const socket = io();

    const charts = {};
    const variables = ["humedad","temperatura","conductividad","pH","nitrogeno","fosforo","potasio","bateria"];

    function createChart(id,label){
      const ctx = document.getElementById(id).getContext("2d");
      charts[id] = new Chart(ctx,{
        type:"line",
        data:{ labels:[], datasets:[{ label, data:[], borderColor:"#00ffff", backgroundColor:"rgba(0,255,255,0.2)", fill:true }] },
        options:{ responsive:true, plugins:{ legend:{ display:true } }, scales:{ x:{ display:true }, y:{ display:true } } }
      });
    }
    variables.forEach(v=>createChart(v,v.charAt(0).toUpperCase()+v.slice(1)));

    let allData = [];
    let currentPage = 1;
    const recordsPerPage = 20;

    function renderTable(){
      const tablaSelect = document.getElementById("tablaSelect").value;
      const tableBody = document.querySelector("#dataTable tbody");
      const totalRecords = allData.length;
      const totalPages = Math.ceil(totalRecords / recordsPerPage);
      const start = (currentPage-1)*recordsPerPage;
      const end = start+recordsPerPage;
      const dataSlice = allData.slice(start,end);
      tableBody.innerHTML = dataSlice.map(d=>`<tr><td>${new Date(d.fecha).toLocaleString()}</td><td>${d[tablaSelect]}</td></tr>`).join("");

      const pagination = document.getElementById("pagination");
      pagination.innerHTML="";
      for(let i=1;i<=totalPages;i++){
        const btn = document.createElement("button");
        btn.textContent=i;
        btn.disabled=i===currentPage;
        btn.onclick=()=>{currentPage=i;renderTable();};
        pagination.appendChild(btn);
      }

      document.getElementById("recordInfo").textContent=`Mostrando ${start+1}-${Math.min(end,totalRecords)} de ${totalRecords} registros`;
    }

    document.getElementById("tablaSelect").addEventListener("change",()=>{ currentPage=1; renderTable(); });

    // ðŸ”¹ Cargar histÃ³rico desde MongoDB al iniciar
    async function loadAllData(){
      try{
        const res = await fetch(`${SERVER_URL}/api/data/all`);
        allData = await res.json();
        renderTable();
      }catch(e){console.error("Error cargando todos los datos:",e);}
    }

    // ðŸ”¹ Escuchar datos en tiempo real (MQTT â†’ Socket.io)
    socket.on("mqttData",(d)=>{
      const fecha = new Date().toLocaleString();
      d.fecha = fecha;
      allData.unshift(d);
      allData = allData.slice(0,200); // mantener 200 Ãºltimos
      renderTable();
      variables.forEach(v=>{
        charts[v].data.labels.push(fecha);
        charts[v].data.datasets[0].data.push(d[v]);
        if(charts[v].data.labels.length>50){
          charts[v].data.labels.shift();
          charts[v].data.datasets[0].data.shift();
        }
        charts[v].update();
      });
    });

    // ðŸ”¹ Si no hay datos MQTT, recargar desde MongoDB
    setInterval(loadAllData, 10000);

    loadAllData();
  </script>
</body>
</html>
