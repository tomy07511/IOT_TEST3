<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Sensores LoRa</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: "Segoe UI", sans-serif; background: #f6f9fc; margin:0; padding:20px; }
    h1 { text-align: center; margin-bottom:30px; }
    .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom:40px; }
    .chart-container { background:white; border-radius:15px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
    table { width:100%; border-collapse:collapse; background:white; border-radius:10px; overflow:hidden; margin-top:15px; }
    th, td { padding:10px; border-bottom:1px solid #ddd; text-align:center; }
    th { background:#007bff; color:white; }
    .pagination { text-align:center; margin-top:10px; }
    select { margin-bottom:10px; padding:5px 10px; }
    .record-info { text-align:center; margin-top:8px; color:#555; }
  </style>
</head>
<body>
  <h1>Panel de Monitoreo LoRa</h1>

  <!-- GRAFICAS -->
  <div class="chart-grid">
    <div class="chart-container"><canvas id="humedad"></canvas></div>
    <div class="chart-container"><canvas id="temperatura"></canvas></div>
    <div class="chart-container"><canvas id="conductividad"></canvas></div>
    <div class="chart-container"><canvas id="pH"></canvas></div>
    <div class="chart-container"><canvas id="nitrogeno"></canvas></div>
    <div class="chart-container"><canvas id="fosforo"></canvas></div>
    <div class="chart-container"><canvas id="potasio"></canvas></div>
    <div class="chart-container"><canvas id="bateria"></canvas></div>
  </div>

  <!-- TABLA -->
  <h2>Registros</h2>
  <select id="tablaSelect">
    <option value="humedad">Humedad</option>
    <option value="temperatura">Temperatura</option>
    <option value="conductividad">Conductividad</option>
    <option value="pH">pH</option>
    <option value="nitrogeno">Nitrógeno</option>
    <option value="fosforo">Fósforo</option>
    <option value="potasio">Potasio</option>
    <option value="bateria">Batería</option>
  </select>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Valor</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination" id="pagination"></div>
  <div class="record-info" id="recordInfo"></div>

  <script>
    const SERVER_URL = "https://iot-test3.onrender.com"; // <- PON AQUÍ TU URL DE RENDER
    const charts = {};
    const variables = ["humedad","temperatura","conductividad","pH","nitrogeno","fosforo","potasio","bateria"];

    // Crear gráficos
    function createChart(id, label) {
      const ctx = document.getElementById(id).getContext("2d");
      charts[id] = new Chart(ctx, {
        type: "line",
        data: { labels: [], datasets: [{ label, data: [], borderColor: "#007bff", fill: false }] },
        options: { responsive:true, plugins:{ legend:{ display:true } }, scales:{ x:{ display:true }, y:{ display:true } } }
      });
    }
    variables.forEach(v => createChart(v, v.charAt(0).toUpperCase() + v.slice(1)));

    // Cargar últimos 10 registros para gráficas
    async function loadLatestData() {
      try {
        const res = await fetch(`${SERVER_URL}/api/data/latest`);
        const data = await res.json();
        console.log("Últimos 10 registros:", data);

        const labels = data.map(d => new Date(d.fecha).toLocaleString());
        variables.forEach(v => {
          charts[v].data.labels = labels;
          charts[v].data.datasets[0].data = data.map(d => d[v]);
          charts[v].update();
        });
      } catch(e) { console.error("Error cargando últimos datos:", e); }
    }

    // Cargar todos los registros para tabla
    let allData = [];
    let currentPage = 1;
    const recordsPerPage = 20;

    async function loadAllData() {
      try {
        const res = await fetch(`${SERVER_URL}/api/data/all`);
        allData = await res.json();
        console.log("Todos los registros:", allData);
        renderTable();
      } catch(e) { console.error("Error cargando todos los datos:", e); }
    }

    function renderTable() {
      const tablaSelect = document.getElementById("tablaSelect").value;
      const tableBody = document.querySelector("#dataTable tbody");
      const totalRecords = allData.length;
      const totalPages = Math.ceil(totalRecords / recordsPerPage);

      const start = (currentPage-1)*recordsPerPage;
      const end = start+recordsPerPage;
      const dataSlice = allData.slice(start,end);

      tableBody.innerHTML = dataSlice.map(d => `
        <tr>
          <td>${new Date(d.fecha).toLocaleString()}</td>
          <td>${d[tablaSelect]}</td>
        </tr>
      `).join("");

      // paginación
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      for(let i=1;i<=totalPages;i++){
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.disabled = i===currentPage;
        btn.onclick = ()=>{ currentPage=i; renderTable(); };
        pagination.appendChild(btn);
      }

      // info
      const recordInfo = document.getElementById("recordInfo");
      recordInfo.textContent = `Mostrando ${start+1}-${Math.min(end,totalRecords)} de ${totalRecords} registros`;
    }

    document.getElementById("tablaSelect").addEventListener("change", ()=>{
      currentPage=1;
      renderTable();
    });

    loadLatestData();
    loadAllData();

    // Auto actualización cada 30s
    setInterval(()=>{
      loadLatestData();
      loadAllData();
    },30000);
  </script>
</body>
</html>
