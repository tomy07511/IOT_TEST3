<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HistÃ³ricos â€” Panel de Sensores</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{
      --bg:#0b1d2a;
      --card:#102a3c;
      --accent:#00e5ff;
      --muted:#1e3a4c;
      --text:#eaf6f8;
    }
    html,body{height:100%;margin:0;font-family:"Segoe UI",system-ui,Arial; background:var(--bg); color:var(--text);}
    header{padding:12px 18px;text-align:center;color:var(--accent);}
    .controls{
      padding:0 16px 8px 16px;
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    select {
      padding:6px;
      border-radius:6px;
      border:1px solid var(--muted);
      background:transparent;
      color:var(--text)
    }
    .download-btn {
      padding: 8px 16px;
      background: var(--accent);
      color: #002;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .download-btn:hover {
      background: #00bcd4;
      transform: translateY(-2px);
    }
    table{
      width:95%;
      margin:14px auto 40px;
      background:var(--card);
      border-collapse:collapse;
      color:var(--text);
      border-radius:8px;
      overflow:hidden
    }
    th,td{
      padding:10px;
      text-align:center;
      border-bottom:1px solid var(--muted)
    }
    th{
      background:linear-gradient(90deg,#004d55,#007f8a);
      color:#eaf6f8
    }
    #pagination{
      padding:10px;
      text-align:center
    }
    #pagination button{
      margin:2px;
      padding:6px 8px;
      border-radius:6px;
      border:none;
      background:var(--accent);
      cursor:pointer
    }
  </style>
</head>
<body>
  <header><h2> HistÃ³ricos â€” Base de Datos</h2></header>

  <div class="controls">
    <label for="tablaSelect" style="color:var(--accent)">Variable:</label>
    <select id="tablaSelect">
      <option value="temperatura">Temperatura</option>
      <option value="humedad">Humedad</option>
      <option value="conductividad">Conductividad</option>
      <option value="ph">pH</option>
      <option value="nitrogeno">NitrÃ³geno</option>
      <option value="fosforo">FÃ³sforo</option>
      <option value="potasio">Potasio</option>
      <option value="bateria">BaterÃ­a</option>
      <option value="corriente">Corriente</option>
    </select>
    
    <button class="download-btn" onclick="downloadCSV()">
      ðŸ“¥ Descargar CSV Completo
    </button>
  </div>

  <table id="dataTable">
    <thead><tr><th>Fecha</th><th>Valor</th></tr></thead>
    <tbody></tbody>
  </table>
  <div id="pagination"></div>

  <script>
  const socket=io();
  let allData=[],currentPage=1;
  const recordsPerPage=20;

  function renderTable(){
    const key=document.getElementById('tablaSelect').value;
    const tbody=document.querySelector('#dataTable tbody');
    const totalPages=Math.ceil(allData.length/recordsPerPage)||1;
    const start=(currentPage-1)*recordsPerPage,end=start+recordsPerPage;
    const slice=allData.slice(start,end);
    tbody.innerHTML=slice.map(d=>{
      let val=d[key];if(val===undefined){for(const k in d){if(k.toLowerCase()===key.toLowerCase()){val=d[k];break;}}}
      if(typeof val==='number') val=val.toFixed(3);
      return `<tr><td>${new Date(d.fecha).toLocaleString()}</td><td>${val??''}</td></tr>`;
    }).join('');
    const pag=document.getElementById('pagination');
    pag.innerHTML='';for(let i=1;i<=totalPages;i++){const b=document.createElement('button');b.textContent=i;b.disabled=i===currentPage;b.onclick=()=>{currentPage=i;renderTable();};pag.appendChild(b);}
  }

  async function loadAll(){
    const res=await fetch('/api/data/all');const json=await res.json();
    allData=json.map(d=>({...d,fecha:new Date(d.fecha)})).sort((a,b)=>b.fecha-a.fecha);
    renderTable();
  }

  // FunciÃ³n para descargar CSV con todas las variables
  function downloadCSV() {
    if (allData.length === 0) {
      alert('No hay datos para descargar');
      return;
    }

    // Definir columnas en el orden deseado
    const columns = [
      'fecha', 'humedad', 'temperatura', 'conductividad', 'ph',
      'nitrogeno', 'fosforo', 'potasio', 'bateria', 'corriente',
      'latitud', 'longitud', 'hora_gps', 'rssi'
    ];

    // Crear encabezados CSV
    const headers = [
      'Fecha',
      'Humedad',
      'Temperatura', 
      'Conductividad',
      'pH',
      'NitrÃ³geno',
      'FÃ³sforo',
      'Potasio',
      'BaterÃ­a',
      'Corriente',
      'Latitud',
      'Longitud',
      'Hora GPS',
      'RSSI'
    ];

    // Crear filas de datos
    const csvRows = [headers.join(',')];
    
    allData.forEach(item => {
      const row = columns.map(col => {
        let value = item[col];
        
        if (col === 'fecha') {
          value = new Date(value).toLocaleString();
        }
        
        if (typeof value === 'number') {
          value = value.toFixed(3);
        }
        
        // Escapar comas y comillas para CSV
        if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
          value = `"${value.replace(/"/g, '""')}"`;
        }
        
        return value || '';
      });
      
      csvRows.push(row.join(','));
    });

    // Crear y descargar archivo
    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `datos_sensores_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  document.getElementById('tablaSelect').onchange=()=>{currentPage=1;renderTable();};
  loadAll();
  </script>
</body>
</html>