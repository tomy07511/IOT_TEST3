<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HistÃ³ricos â€” Panel de Sensores</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{
      --bg:#0b1d2a;
      --card:#102a3c;
      --accent:#00e5ff;
      --muted:#1e3a4c;
      --text:#eaf6f8;
    }
    html,body{height:100%;margin:0;font-family:"Segoe UI",system-ui,Arial; background:var(--bg); color:var(--text);}
    header{padding:12px 18px;text-align:center;color:var(--accent);}
    
    .controls{
      padding:15px;
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      background: var(--card);
      margin: 15px;
      border-radius: 8px;
    }
    
    select {
      padding:8px 12px;
      border-radius:6px;
      border:1px solid var(--muted);
      background:var(--card);
      color:var(--text);
      font-size: 14px;
    }
    
    .download-btn {
      padding: 10px 20px;
      background: var(--accent);
      color: #002;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .download-btn:hover {
      background: #00bcd4;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,229,255,0.3);
    }
    
    table{
      width:95%;
      margin:14px auto 40px;
      background:var(--card);
      border-collapse:collapse;
      color:var(--text);
      border-radius:8px;
      overflow:hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    th,td{
      padding:12px;
      text-align:center;
      border-bottom:1px solid var(--muted)
    }
    
    th{
      background:linear-gradient(90deg,#004d55,#007f8a);
      color:#eaf6f8;
      font-weight: 600;
    }
    
    tr:hover {
      background: rgba(0,229,255,0.05);
    }
    
    #pagination{
      padding:15px;
      text-align:center;
    }
    
    #pagination button{
      margin:4px;
      padding:8px 12px;
      border-radius:6px;
      border:none;
      background:var(--accent);
      color:#002;
      cursor:pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    #pagination button:hover:not(:disabled){
      background:#00bcd4;
      transform: translateY(-2px);
    }
    
    #pagination button:disabled{
      background:#007f8a;
      cursor: not-allowed;
      transform: none;
    }
  </style>
</head>
<body>
  <header>
    <h2>ğŸ“Š HistÃ³ricos â€” Base de Datos</h2>
  </header>

  <div class="controls">
    <label for="tablaSelect" style="color:var(--accent); font-weight: 600;">Variable:</label>
    <select id="tablaSelect">
      <option value="temperatura">ğŸŒ¡ï¸ Temperatura</option>
      <option value="humedad">ğŸ’§ Humedad</option>
      <option value="conductividad">âš¡ Conductividad</option>
      <option value="ph">ğŸ§ª pH</option>
      <option value="nitrogeno">ğŸ”µ NitrÃ³geno</option>
      <option value="fosforo">ğŸ”´ FÃ³sforo</option>
      <option value="potasio">ğŸŸ¢ Potasio</option>
      <option value="bateria">ğŸ”‹ BaterÃ­a</option>
      <option value="corriente">ğŸ“Š Corriente</option>
    </select>
    
    <button class="download-btn" onclick="downloadCSV()">
      ğŸ“¥ Descargar CSV Completo
    </button>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th>ğŸ“… Fecha</th>
        <th>ğŸ”¢ Valor</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  
  <div id="pagination"></div>

  <script>
  const socket = io();
  let allData = [], currentPage = 1;
  const recordsPerPage = 20;

  function renderTable(){
    const key = document.getElementById('tablaSelect').value;
    const tbody = document.querySelector('#dataTable tbody');
    const totalPages = Math.ceil(allData.length / recordsPerPage) || 1;
    const start = (currentPage - 1) * recordsPerPage;
    const end = start + recordsPerPage;
    const slice = allData.slice(start, end);
    
    tbody.innerHTML = slice.map(d => {
      let val = d[key];
      if(val === undefined){
        for(const k in d){
          if(k.toLowerCase() === key.toLowerCase()){
            val = d[k];
            break;
          }
        }
      }
      if(typeof val === 'number') val = val.toFixed(3);
      return `<tr><td>${new Date(d.fecha).toLocaleString()}</td><td>${val ?? ''}</td></tr>`;
    }).join('');
    
    const pag = document.getElementById('pagination');
    pag.innerHTML = '';
    for(let i = 1; i <= totalPages; i++){
      const b = document.createElement('button');
      b.textContent = i;
      b.disabled = i === currentPage;
      b.onclick = () => {
        currentPage = i;
        renderTable();
      };
      pag.appendChild(b);
    }
  }

  async function loadAll(){
    try {
      const res = await fetch('/api/data/all');
      const json = await res.json();
      allData = json.map(d => ({...d, fecha: new Date(d.fecha)})).sort((a, b) => b.fecha - a.fecha);
      renderTable();
    } catch (error) {
      console.error('Error cargando datos:', error);
      alert('Error al cargar los datos histÃ³ricos');
    }
  }

  // FunciÃ³n para descargar CSV con todas las variables
  function downloadCSV() {
    if (allData.length === 0) {
      alert('No hay datos para descargar');
      return;
    }

    // Mostrar mensaje de descarga
    alert(`Descargando CSV con ${allData.length} registros...`);

    // Definir columnas en el orden deseado
    const columns = [
      'fecha', 'humedad', 'temperatura', 'conductividad', 'ph',
      'nitrogeno', 'fosforo', 'potasio', 'bateria', 'corriente',
      'latitud', 'longitud', 'hora_gps', 'rssi'
    ];

    // Crear encabezados CSV
    const headers = [
      'Fecha',
      'Humedad',
      'Temperatura', 
      'Conductividad',
      'pH',
      'NitrÃ³geno',
      'FÃ³sforo',
      'Potasio',
      'BaterÃ­a',
      'Corriente',
      'Latitud',
      'Longitud',
      'Hora GPS',
      'RSSI'
    ];

    // Crear filas de datos
    const csvRows = [headers.join(',')];
    
    allData.forEach(item => {
      const row = columns.map(col => {
        let value = item[col];
        
        if (col === 'fecha') {
          value = new Date(value).toLocaleString();
        }
        
        if (typeof value === 'number') {
          value = value.toFixed(3);
        }
        
        // Escapar comas y comillas para CSV
        if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
          value = `"${value.replace(/"/g, '""')}"`;
        }
        
        return value || '';
      });
      
      csvRows.push(row.join(','));
    });

    // Crear y descargar archivo
    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `datos_sensores_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  document.getElementById('tablaSelect').onchange = () => {
    currentPage = 1;
    renderTable();
  };
  
  loadAll();
  </script>
</body>
</html>