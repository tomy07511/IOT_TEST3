<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HistÃ³ricos â€” Panel de Sensores</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{
      --bg:#0b1d2a;
      --card:#102a3c;
      --accent:#00e5ff;
      --muted:#1e3a4c;
      --text:#eaf6f8;
    }
    html,body{height:100%;margin:0;font-family:"Segoe UI",system-ui,Arial; background:var(--bg); color:var(--text);}
    header{padding:12px 18px;text-align:center;color:var(--accent);}
    .controls{padding:0 16px 8px 16px}
    select {padding:6px;border-radius:6px;border:1px solid var(--muted);background:transparent;color:var(--text)}
    table{width:95%;margin:14px auto 40px;background:var(--card);border-collapse:collapse;color:var(--text);border-radius:8px;overflow:hidden}
    th,td{padding:10px;text-align:center;border-bottom:1px solid var(--muted)}
    th{background:linear-gradient(90deg,#004d55,#007f8a);color:#fff}
    #pagination{padding:10px;text-align:center}
    #pagination button{margin:2px;padding:6px 8px;border-radius:6px;border:none;background:var(--accent);cursor:pointer}
  </style>
</head>
<body>
  <header><h2>ðŸ“Š HistÃ³ricos â€” Base de Datos</h2></header>

  <div class="controls">
    <label for="tablaSelect" style="color:var(--accent)">Variable:</label>
    <select id="tablaSelect">
      <option value="temperatura">Temperatura</option>
      <option value="humedad">Humedad</option>
      <option value="conductividad">Conductividad</option>
      <option value="ph">pH</option>
      <option value="nitrogeno">NitrÃ³geno</option>
      <option value="fosforo">FÃ³sforo</option>
      <option value="potasio">Potasio</option>
      <option value="bateria">BaterÃ­a</option>
      <option value="corriente">Corriente</option>
    </select>
  </div>

  <table id="dataTable">
    <thead><tr><th>Fecha</th><th>Valor</th></tr></thead>
    <tbody></tbody>
  </table>
  <div id="pagination"></div>

  <script>
  const socket=io();
  let allData=[],currentPage=1;
  const recordsPerPage=20;

  function renderTable(){
    const key=document.getElementById('tablaSelect').value;
    const tbody=document.querySelector('#dataTable tbody');
    const totalPages=Math.ceil(allData.length/recordsPerPage)||1;
    const start=(currentPage-1)*recordsPerPage,end=start+recordsPerPage;
    const slice=allData.slice(start,end);
    tbody.innerHTML=slice.map(d=>{
      let val=d[key];if(val===undefined){for(const k in d){if(k.toLowerCase()===key.toLowerCase()){val=d[k];break;}}}
      if(typeof val==='number') val=val.toFixed(3);
      return `<tr><td>${new Date(d.fecha).toLocaleString()}</td><td>${val??''}</td></tr>`;
    }).join('');
    const pag=document.getElementById('pagination');
    pag.innerHTML='';for(let i=1;i<=totalPages;i++){const b=document.createElement('button');b.textContent=i;b.disabled=i===currentPage;b.onclick=()=>{currentPage=i;renderTable();};pag.appendChild(b);}
  }

  async function loadAll(){
    const res=await fetch('/api/data/all');const json=await res.json();
    allData=json.map(d=>({...d,fecha:new Date(d.fecha)})).sort((a,b)=>b.fecha-a.fecha);
    renderTable();
  }

  document.getElementById('tablaSelect').onchange=()=>{currentPage=1;renderTable();};
  loadAll();
  </script>
</body>
</html>
