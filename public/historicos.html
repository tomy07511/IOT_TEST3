<script>
  // Script para Meteorolog칤a - Mostrar datos en tiempo real
  const socket = io();
  
  // Variables para almacenar datos meteorol칩gicos
  let windSpeedData = [];
  let temperatureData = [];
  let humidityData = [];
  let timestamps = [];
  const MAX_DATA_POINTS = 50;

  // Inicializar gr치ficas meteorol칩gicas
  function initMeteoroCharts() {
    // Gr치fica de Temperatura
    if (document.getElementById('temp-chart')) {
      Plotly.newPlot('temp-chart', [{
        x: timestamps,
        y: temperatureData,
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#ff7043', width: 3 },
        marker: { size: 4 },
        name: 'Temperatura'
      }], {
        title: '',
        plot_bgcolor: 'transparent',
        paper_bgcolor: 'transparent',
        font: { color: '#eaf6f8' },
        xaxis: { gridcolor: '#1e3a4c', title: 'Tiempo' },
        yaxis: { gridcolor: '#1e3a4c', title: 'Temperatura (춿C)' },
        margin: { t: 30, r: 30, b: 50, l: 50 }
      });
    }
    
    // Gr치fica de Velocidad del Viento
    if (document.getElementById('wind-chart')) {
      Plotly.newPlot('wind-chart', [{
        x: timestamps,
        y: windSpeedData,
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#00e5ff', width: 3 },
        marker: { size: 4 },
        name: 'Velocidad del Viento'
      }], {
        title: '',
        plot_bgcolor: 'transparent',
        paper_bgcolor: 'transparent',
        font: { color: '#eaf6f8' },
        xaxis: { gridcolor: '#1e3a4c', title: 'Tiempo' },
        yaxis: { gridcolor: '#1e3a4c', title: 'Velocidad (km/h)' },
        margin: { t: 30, r: 30, b: 50, l: 50 }
      });
    }
    
    // Gr치fica de Humedad
    if (document.getElementById('humidity-chart')) {
      Plotly.newPlot('humidity-chart', [{
        x: timestamps,
        y: humidityData,
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#4ecdc4', width: 3 },
        marker: { size: 4 },
        name: 'Humedad'
      }], {
        title: '',
        plot_bgcolor: 'transparent',
        paper_bgcolor: 'transparent',
        font: { color: '#eaf6f8' },
        xaxis: { gridcolor: '#1e3a4c', title: 'Tiempo' },
        yaxis: { gridcolor: '#1e3a4c', title: 'Humedad (%)' },
        margin: { t: 30, r: 30, b: 50, l: 50 }
      });
    }
  }

  // Actualizar datos meteorol칩gicos en tiempo real
  function updateMeteoroData(data) {
    if (!data) return;
    
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    
    // Agregar nuevos datos
    timestamps.push(timeString);
    temperatureData.push(data.temperatura || 0);
    windSpeedData.push(data.vel_viento || 0);
    humidityData.push(data.humedad || 0);
    
    // Limitar el n칰mero de puntos de datos
    if (timestamps.length > MAX_DATA_POINTS) {
      timestamps.shift();
      temperatureData.shift();
      windSpeedData.shift();
      humidityData.shift();
    }
    
    // Actualizar indicadores actuales
    document.getElementById('current-temp').textContent = `${(data.temperatura || 0).toFixed(1)} 춿C`;
    document.getElementById('current-wind').textContent = `${(data.vel_viento || 0).toFixed(1)} km/h`;
    document.getElementById('current-humidity').textContent = `${(data.humedad || 0).toFixed(0)} %`;
    
    // Actualizar direcci칩n del viento (simulada por ahora)
    const windDirection = Math.floor(Math.random() * 360); // Simulado hasta que tengas el dato real
    updateWindDirection(windDirection);
    
    // Actualizar gr치ficas
    updateMeteoroCharts();
  }

  // Actualizar gr치ficas meteorol칩gicas
  function updateMeteoroCharts() {
    // Actualizar gr치fica de temperatura
    if (document.getElementById('temp-chart')) {
      Plotly.react('temp-chart', [{
        x: timestamps,
        y: temperatureData,
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#ff7043', width: 3 },
        marker: { size: 4 },
        name: 'Temperatura'
      }], {
        xaxis: { range: [timestamps[0], timestamps[timestamps.length - 1]] }
      });
    }
    
    // Actualizar gr치fica de velocidad del viento
    if (document.getElementById('wind-chart')) {
      Plotly.react('wind-chart', [{
        x: timestamps,
        y: windSpeedData,
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#00e5ff', width: 3 },
        marker: { size: 4 },
        name: 'Velocidad del Viento'
      }], {
        xaxis: { range: [timestamps[0], timestamps[timestamps.length - 1]] }
      });
    }
    
    // Actualizar gr치fica de humedad
    if (document.getElementById('humidity-chart')) {
      Plotly.react('humidity-chart', [{
        x: timestamps,
        y: humidityData,
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#4ecdc4', width: 3 },
        marker: { size: 4 },
        name: 'Humedad'
      }], {
        xaxis: { range: [timestamps[0], timestamps[timestamps.length - 1]] }
      });
    }
  }

  // Actualizar br칰jula de direcci칩n del viento
  function updateWindDirection(degrees) {
    const needle = document.getElementById('wind-needle');
    const directionText = document.getElementById('wind-direction-text');
    
    if (!needle || !directionText) return;
    
    needle.style.transform = `translate(-50%, -50%) rotate(${degrees}deg)`;
    
    // Convertir grados a direcci칩n cardinal
    const directions = ['Norte', 'Noreste', 'Este', 'Sureste', 'Sur', 'Suroeste', 'Oeste', 'Noroeste'];
    const index = Math.round(degrees / 45) % 8;
    directionText.textContent = `${directions[index]} (${degrees}춿)`;
  }

  // Escuchar datos del servidor
  socket.on('nuevoDato', function(data) {
    console.log('游니 Dato meteorol칩gico recibido:', data);
    updateMeteoroData(data);
  });

  // Inicializar cuando se active la pesta침a de Meteorolog칤a
  function initMeteorologia() {
    // Inicializar con datos vac칤os
    initMeteoroCharts();
    
    // Cargar algunos datos hist칩ricos iniciales (opcional)
    setTimeout(() => {
      // Simular algunos datos iniciales para que las gr치ficas no est칠n vac칤as
      for (let i = 0; i < 10; i++) {
        const mockData = {
          temperatura: 25 + Math.random() * 10,
          vel_viento: Math.random() * 20,
          humedad: 50 + Math.random() * 30
        };
        updateMeteoroData(mockData);
      }
    }, 1000);
  }

  // Inicializar cuando la pesta침a est칠 activa
  document.addEventListener('DOMContentLoaded', function() {
    // Verificar si estamos en la pesta침a de Meteorolog칤a
    if (document.getElementById('meteoro-tab').classList.contains('active')) {
      initMeteorologia();
    }
  });
</script>