<!-- CONTENIDO METEOROLOGÃA -->
<div id="meteoro-tab" class="tab-content">
  <div class="container">
    <!-- Indicadores de datos actuales -->
    <div class="current-data">
      <div class="data-card">
        <div class="data-label">Temperatura Actual</div>
        <div class="data-value" id="current-temp">-- Â°C</div>
        <div class="data-label">Ambiente</div>
      </div>
      
      <div class="data-card">
        <div class="data-label">Velocidad del Viento</div>
        <div class="data-value" id="current-wind">-- km/h</div>
        <div class="data-label">Tiempo Real</div>
      </div>
      
      <div class="data-card">
        <div class="data-label">Humedad Ambiente</div>
        <div class="data-value" id="current-humidity">-- %</div>
        <div class="data-label">Relativa</div>
      </div>
      
      <div class="data-card">
        <div class="data-label">Direccion del Viento</div>
        <div class="data-value" id="current-direction">--</div>
        <div class="data-label">Rumbo actual</div>
      </div>
    </div>

    <!-- Grid principal: GrÃ¡ficas y BrÃºjula -->
    <div class="dashboard-grid">
      <!-- GrÃ¡fica de Temperatura -->
      <div class="card">
        <h3>Temperatura Ambiente</h3>
        <div class="graph-container" id="temp-chart">
          <div class="loading">Cargando grafica de temperatura...</div>
        </div>
      </div>
      
      <!-- GrÃ¡fica de Velocidad del Viento -->
      <div class="card">
        <h3>Velocidad del Viento</h3>
        <div class="graph-container" id="wind-chart">
          <div class="loading">Cargando grafica de viento...</div>
        </div>
      </div>
      
      <!-- BrÃºjula/Rosa de los Vientos -->
      <div class="card">
        <h3>Direccion del Viento</h3>
        <div class="compass-container">
          <div class="compass">
            <div class="compass-rose"></div>
            <div class="compass-needle" id="wind-needle"></div>
            <div class="compass-center"></div>
            <div class="compass-directions">
              <div class="direction-n">N</div>
              <div class="direction-e">E</div>
              <div class="direction-s">S</div>
              <div class="direction-w">O</div>
            </div>
          </div>
          <div style="margin-top: 20px; text-align: center;">
            <div class="data-label">Direccion actual:</div>
            <div class="data-value" id="wind-direction-text">Norte (0Â°)</div>
          </div>
        </div>
      </div>
      
      <!-- GrÃ¡fica de Humedad -->
      <div class="card">
        <h3>Humedad Ambiente</h3>
        <div class="graph-container" id="humidity-chart">
          <div class="loading">Cargando grafica de humedad...</div>
        </div>
      </div>
    </div>

    <!-- InformaciÃ³n adicional (sin presiÃ³n atmosfÃ©rica) -->
    <div class="card">
      <h3>Resumen Meteorologico</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
        <div class="data-card">
          <div class="data-label">Maxima del dia</div>
          <div class="data-value">-- Â°C</div>
        </div>
        <div class="data-card">
          <div class="data-label">Minima del dia</div>
          <div class="data-value">-- Â°C</div>
        </div>
        <div class="data-card">
          <div class="data-label">Rafaga maxima</div>
          <div class="data-value">-- km/h</div>
        </div>
        <div class="data-card">
          <div class="data-label">Humedad promedio</div>
          <div class="data-value">-- %</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Script para MeteorologÃ­a - Mostrar datos en tiempo real
  const socket = io();
  
  // Variables para almacenar datos meteorolÃ³gicos
  let windSpeedData = [];
  let temperatureData = [];
  let humidityData = [];
  let timestamps = [];
  const MAX_DATA_POINTS = 50;

  // Inicializar grÃ¡ficas meteorolÃ³gicas
  function initMeteoroCharts() {
    // GrÃ¡fica de Temperatura
    if (document.getElementById('temp-chart')) {
      Plotly.newPlot('temp-chart', [{
        x: timestamps,
        y: temperatureData,
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#ff7043', width: 3 },
        marker: { size: 4 },
        name: 'Temperatura'
      }], {
        title: '',
        plot_bgcolor: 'transparent',
        paper_bgcolor: 'transparent',
        font: { color: '#eaf6f8' },
        xaxis: { gridcolor: '#1e3a4c', title: 'Tiempo' },
        yaxis: { gridcolor: '#1e3a4c', title: 'Temperatura (Â°C)' },
        margin: { t: 30, r: 30, b: 50, l: 50 }
      });
    }
    
    // GrÃ¡fica de Velocidad del Viento
    if (document.getElementById('wind-chart')) {
      Plotly.newPlot('wind-chart', [{
        x: timestamps,
        y: windSpeedData,
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#00e5ff', width: 3 },
        marker: { size: 4 },
        name: 'Velocidad del Viento'
      }], {
        title: '',
        plot_bgcolor: 'transparent',
        paper_bgcolor: 'transparent',
        font: { color: '#eaf6f8' },
        xaxis: { gridcolor: '#1e3a4c', title: 'Tiempo' },
        yaxis: { gridcolor: '#1e3a4c', title: 'Velocidad (km/h)' },
        margin: { t: 30, r: 30, b: 50, l: 50 }
      });
    }
    
    // GrÃ¡fica de Humedad
    if (document.getElementById('humidity-chart')) {
      Plotly.newPlot('humidity-chart', [{
        x: timestamps,
        y: humidityData,
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#4ecdc4', width: 3 },
        marker: { size: 4 },
        name: 'Humedad'
      }], {
        title: '',
        plot_bgcolor: 'transparent',
        paper_bgcolor: 'transparent',
        font: { color: '#eaf6f8' },
        xaxis: { gridcolor: '#1e3a4c', title: 'Tiempo' },
        yaxis: { gridcolor: '#1e3a4c', title: 'Humedad (%)' },
        margin: { t: 30, r: 30, b: 50, l: 50 }
      });
    }
  }

  // Actualizar datos meteorolÃ³gicos en tiempo real
  function updateMeteoroData(data) {
    if (!data) return;
    
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    
    console.log('ðŸ“¡ Datos recibidos para meteorologÃ­a:', {
      temperatura: data.temperatura,
      vel_viento: data.vel_viento,
      humedad: data.humedad
    });
    
    // Agregar nuevos datos
    timestamps.push(timeString);
    temperatureData.push(data.temperatura || 0);
    windSpeedData.push(data.vel_viento || 0);
    humidityData.push(data.humedad || 0);
    
    // Limitar el nÃºmero de puntos de datos
    if (timestamps.length > MAX_DATA_POINTS) {
      timestamps.shift();
      temperatureData.shift();
      windSpeedData.shift();
      humidityData.shift();
    }
    
    // Actualizar indicadores actuales
    document.getElementById('current-temp').textContent = `${(data.temperatura || 0).toFixed(1)} Â°C`;
    document.getElementById('current-wind').textContent = `${(data.vel_viento || 0).toFixed(1)} km/h`;
    document.getElementById('current-humidity').textContent = `${(data.humedad || 0).toFixed(0)} %`;
    
    // Actualizar direcciÃ³n del viento (simulada por ahora)
    const windDirection = Math.floor(Math.random() * 360); // Simulado hasta que tengas el dato real
    updateWindDirection(windDirection);
    
    // Actualizar grÃ¡ficas
    updateMeteoroCharts();
  }

  // Actualizar grÃ¡ficas meteorolÃ³gicas
  function updateMeteoroCharts() {
    // Actualizar grÃ¡fica de temperatura
    if (document.getElementById('temp-chart') && timestamps.length > 0) {
      Plotly.react('temp-chart', [{
        x: timestamps,
        y: temperatureData,
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#ff7043', width: 3 },
        marker: { size: 4 },
        name: 'Temperatura'
      }], {
        xaxis: { range: [timestamps[0], timestamps[timestamps.length - 1]] }
      });
    }
    
    // Actualizar grÃ¡fica de velocidad del viento
    if (document.getElementById('wind-chart') && timestamps.length > 0) {
      Plotly.react('wind-chart', [{
        x: timestamps,
        y: windSpeedData,
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#00e5ff', width: 3 },
        marker: { size: 4 },
        name: 'Velocidad del Viento'
      }], {
        xaxis: { range: [timestamps[0], timestamps[timestamps.length - 1]] }
      });
    }
    
    // Actualizar grÃ¡fica de humedad
    if (document.getElementById('humidity-chart') && timestamps.length > 0) {
      Plotly.react('humidity-chart', [{
        x: timestamps,
        y: humidityData,
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#4ecdc4', width: 3 },
        marker: { size: 4 },
        name: 'Humedad'
      }], {
        xaxis: { range: [timestamps[0], timestamps[timestamps.length - 1]] }
      });
    }
  }

  // Actualizar brÃºjula de direcciÃ³n del viento
  function updateWindDirection(degrees) {
    const needle = document.getElementById('wind-needle');
    const directionText = document.getElementById('wind-direction-text');
    
    if (!needle || !directionText) return;
    
    needle.style.transform = `translate(-50%, -50%) rotate(${degrees}deg)`;
    
    // Convertir grados a direcciÃ³n cardinal
    const directions = ['Norte', 'Noreste', 'Este', 'Sureste', 'Sur', 'Suroeste', 'Oeste', 'Noroeste'];
    const index = Math.round(degrees / 45) % 8;
    directionText.textContent = `${directions[index]} (${degrees}Â°)`;
  }

  // Escuchar datos del servidor
  socket.on('nuevoDato', function(data) {
    console.log('ðŸ“¡ Dato MQTT recibido en meteorologÃ­a:', {
      temperatura: data.temperatura,
      vel_viento: data.vel_viento,
      humedad: data.humedad
    });
    updateMeteoroData(data);
  });

  // Inicializar cuando se active la pestaÃ±a de MeteorologÃ­a
  function initMeteorologia() {
    console.log('ðŸŒ¤ï¸ Inicializando estaciÃ³n meteorolÃ³gica...');
    // Inicializar con datos vacÃ­os
    initMeteoroCharts();
    
    // Cargar algunos datos histÃ³ricos iniciales (opcional)
    setTimeout(() => {
      // Simular algunos datos iniciales para que las grÃ¡ficas no estÃ©n vacÃ­as
      for (let i = 0; i < 5; i++) {
        const mockData = {
          temperatura: 25 + Math.random() * 10,
          vel_viento: Math.random() * 5, // Velocidades bajas como en tus logs
          humedad: 60 + Math.random() * 20 // Humedad entre 60-80%
        };
        updateMeteoroData(mockData);
      }
    }, 500);
  }

  // Inicializar cuando la pestaÃ±a estÃ© activa
  if (document.getElementById('meteoro-tab')) {
    // Verificar si estamos en la pestaÃ±a de MeteorologÃ­a
    const meteoroTab = document.getElementById('meteoro-tab');
    if (meteoroTab.classList.contains('active')) {
      initMeteorologia();
    }
    
    // TambiÃ©n inicializar cuando se cambie a esta pestaÃ±a
    window.switchTab = function(tabName) {
      // ... (tu cÃ³digo existente de switchTab)
      
      if (tabName === 'meteoro') {
        setTimeout(initMeteorologia, 100);
      }
    }
  }
</script>